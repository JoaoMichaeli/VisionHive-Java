trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  -group: DB-Credentials
  WEB_APP_NAME: 'visionhive'
  RESOURCE_GROUP: 'rg-visionhive'
  IMAGE_TAG: '$(Build.BuildId)'
  ACR_NAME: 'visionhiveacr'
  IMAGE_NAME: '$$ (ACR_NAME).azurecr.io/ $$(WEB_APP_NAME):$(IMAGE_TAG)'

stages:
  - stage: Build
    displayName: 'CI: Build & Docker Push to ACR'
    jobs:
      - job: Build
        steps:
          - task: Gradle@3
            inputs:
              gradleWrapperFile: 'gradlew'
              tasks: 'clean bootJar'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
            displayName: 'Gradle: Build'

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: 'build/libs'
              artifact: 'jar-artifact'
              publishLocation: 'pipeline'
            displayName: 'Publicar Artefato JAR'

          - task: Docker@2
            displayName: 'Login to ACR'
            inputs:
              command: login
              containerRegistry: 'acr-connection'

          - task: Docker@2
            displayName: 'Build & Push Docker to ACR'
            inputs:
              command: buildAndPush
              repository: $(WEB_APP_NAME)
              dockerfile: 'Dockerfile'
              containerRegistry: 'acr-connection'
              tags: |
                $(IMAGE_TAG)
                latest

  - stage: Deploy
    displayName: 'CD: Deploy from ACR to Web App'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployWebApp
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebAppContainer@1
                  inputs:
                    azureSubscription: 'Azure subscription'
                    appName: $(WEB_APP_NAME)
                    imageName: '$(IMAGE_NAME)'
                    resourceGroupName: $(RESOURCE_GROUP)
                  displayName: 'Deploy no Azure Web App'