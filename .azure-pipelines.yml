trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  -group: DB-Credentials
  WEB_APP_NAME: 'visionhive'
  RESOURCE_GROUP: 'rg-visionhive'
  IMAGE_TAG: '$(Build.BuildId)'

stages:
  - stage: Build
    displayName: 'CI: Build & Docker'
    jobs:
      - job: Build
        steps:
          - task: Gradle@3
            inputs:
              gradleWrapperFile: 'gradlew'
              tasks: 'clean bootJar'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.17'
            displayName: 'Gradle: Build'

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: 'build/libs'
              artifact: 'jar-artifact'
              publishLocation: 'pipeline'
            displayName: 'Publicar Artefato JAR'

          - script: |
              echo "Construindo imagem Docker: $(WEB_APP_NAME):$(IMAGE_TAG)"
              docker build --progress=plain -t $(WEB_APP_NAME):$(IMAGE_TAG) -f Dockerfile .
            workingDirectory: '$(System.DefaultWorkingDirectory)'
            displayName: 'Build Docker Image'

  - stage: Deploy
    displayName: 'CD: Deploy no Web App'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployWebApp
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebAppContainer@1
                  inputs:
                    azureSubscription: 'Azure subscription'
                    appName: $(WEB_APP_NAME)
                    imageName: '$(WEB_APP_NAME):$(IMAGE_TAG)'
                    resourceGroupName: $(RESOURCE_GROUP)
                  displayName: 'Deploy no Azure Web App'